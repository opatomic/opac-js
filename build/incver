#!/bin/bash

function handleErr {
	SNAME=$(basename $BASH_SOURCE)
	echo "$SNAME: Error on line $1"
	exit 1
}

trap 'handleErr $LINENO' ERR

MODCNT=`git status --porcelain | wc -l`
if [ $MODCNT -ne 0 ]; then
	echo "There are $MODCNT changes. Must revert or check in changes."
	exit 1
fi

VERSION=`awk -F '.' '{printf("%d.%d.%d",$1,$2,$3+1)}' version.txt`

# run a build to make sure there's no problems building
# set version so that docs will contain correct version
VERSION="v$VERSION" ./build

# TODO: run tests here; do not proceed if they fail

rm -r out

# write new version to file
printf "$VERSION" > version.txt

git add -A ../docs/
git add version.txt

git commit -m "build v$VERSION"
git tag -a "v$VERSION" -m "v$VERSION"

echo "committed and tagged v$VERSION"

git push --follow-tags


