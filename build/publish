#!/bin/bash

function handleErr {
	SNAME=$(basename $BASH_SOURCE)
	echo "$SNAME: Error on line $1"
	exit 1
}

trap 'handleErr $LINENO' ERR

MODCNT=`git status --porcelain | wc -l`
if [ $MODCNT -ne 0 ]; then
	echo "There are $MODCNT changes. Must revert or check in changes."
	exit 1
fi

# increment the version build number; awk must write to temp file
awk -F '.' '{printf("%d.%d.%d",$1,$2,$3+1)}' version.txt > newver.txt
mv newver.txt version.txt
VERSION=`cat version.txt`


./build --publish

git add -A ../docs/
git add version.txt
git add -A browser/
git add -A node/

git commit -m "build v$VERSION"

npm publish node

echo "published v$VERSION"

