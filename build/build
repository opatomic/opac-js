#!/bin/bash

# to minimize browser build, must have java 8+ installed, download
# closure compiler, and set $CCJAR to the jar file's path.
#  https://github.com/google/closure-compiler

# to generate docs, must have jsdoc installed. install for node using the following command
#  npm install -g jsdoc

# TODO: support running closure compiler from within node?

CCJAR=~/Downloads/closure.compiler/closure-compiler-v20180204.jar
OPACJSDIR=../src
LIBDIR=../lib
TMPDIR=tmp


if [ ! -f $CCJAR ]; then
	# if $CCJAR file does not exist, search current directory for CC
	CCJAR=`find *closure*compiler*.jar | tail -1`
fi

function deldir {
	if [ -d "$1" ]; then
		rm -r "$1"
	fi
}

function ensureDir {
	if [ ! -d "$1" ]; then
		mkdir "$1"
	fi
}

function catAllSrc {
	cat "$TMPDIR/version.js" "$OPACJSDIR/Queue.js" "$OPACJSDIR/BigDec.js" "$OPACJSDIR/OpaDef.js" "$OPACJSDIR/PartialParser.js" "$OPACJSDIR/Serializer.js" "$OPACJSDIR/OpaUtils.js" "$OPACJSDIR/EventClient.js" >> $1
}


ensureDir "browser"
ensureDir "node"

deldir $TMPDIR
mkdir $TMPDIR


if [[ $# -eq 1 && $1 = "--publish" ]]; then
	VERSUFF=
else
	VERSUFF=-dev
fi

VERSION=`cat version.txt`
VERSION=$VERSION$VERSUFF


printf "var VERSION = \"$VERSION\";\n\n" >> "$TMPDIR/version.js"


printf "var BigInteger = (function(){\n" > "$TMPDIR/jsbn.js"
cat "$LIBDIR/jsbn/jsbn.js" "$LIBDIR/jsbn/jsbn2.js" >> "$TMPDIR/jsbn.js"
printf "\nreturn BigInteger;\n}());\n" >> "$TMPDIR/jsbn.js"


rm "browser/opac.browser.min.js"
if [ -f $CCJAR ]; then
	java -jar "$CCJAR" --js "$TMPDIR/jsbn.js" --js_output_file "$TMPDIR/jsbn.min.js"
	java -jar "$CCJAR" --js "browser.head.js" "$TMPDIR/version.js" "$OPACJSDIR/*.js" "browser.foot.js" --externs "biginteger.externs.js" --js_output_file "$TMPDIR/bundle.min.js" --rewrite_polyfills=false --assume_function_wrapper --extra_annotation_name callback --extra_annotation_name hideconstructor -W VERBOSE

	printf "// Minimized and bundled source code for opatomic client. see https://github.com/opatomic/opac-js for more info\n\n" >> "browser/opac.browser.min.js"
	printf "/* BigInteger (http://www-cs-students.stanford.edu/~tjw/jsbn/) LICENSE file: */\n" >> "browser/opac.browser.min.js"
	cat "$LIBDIR/jsbn/LICENSE" >> "browser/opac.browser.min.js"
	printf "\n\n(function(){" >> "browser/opac.browser.min.js"
	cat "$TMPDIR/jsbn.min.js" "$TMPDIR/bundle.min.js" >> "browser/opac.browser.min.js"
	printf "}());\n" >> "browser/opac.browser.min.js"
else
	echo "CCJAR not found. browser build will not minimize"
fi


printf "// Bundled source code for opatomic client. see https://github.com/opatomic/opac-js for more info\n" > "browser/opac.browser.js"
printf "(function(){\n" >> "browser/opac.browser.js"
cat "browser.head.js" >> "browser/opac.browser.js"
printf "// BigInteger (http://www-cs-students.stanford.edu/~tjw/jsbn/):\n" >> "browser/opac.browser.js"
cat "$LIBDIR/jsbn/LICENSE" "$TMPDIR/jsbn.js" >> "browser/opac.browser.js"
printf "\n\n" >> "browser/opac.browser.js"
catAllSrc "browser/opac.browser.js"
cat "browser.foot.js" >> "browser/opac.browser.js"
printf "})();\n" >> "browser/opac.browser.js"


cat "node.head.js" > "node/opac.node.js"
catAllSrc "node/opac.node.js"
cat "node.foot.js" >> "node/opac.node.js"
sed -e "s/\\\$VERSION/$VERSION/" "package.json" > "node/package.json"
cp "../README.md" "node/README.md"


deldir $TMPDIR


# TODO: run some tests!!!

deldir "docs"
jsdoc "$OPACJSDIR/" -d "docs/" -c "jsdoc.conf.json"
deldir "docs/fonts"


