#!/bin/bash

function handleErr {
	SNAME=$(basename $BASH_SOURCE)
	echo "$SNAME: Error on line $1"
	exit 1
}

trap 'handleErr $LINENO' ERR

# to minimize browser build, must have java 8+ installed, download
# closure compiler, and set $CCJAR to the jar file's path.
#  https://github.com/google/closure-compiler

# to generate docs, must have jsdoc installed. install for node using the following command
#  npm install -g jsdoc

CCJAR=~/Downloads/closure.compiler/closure-compiler-v20180204.jar
OPACJSDIR=../src
LIBDIR=../lib
TMPDIR=tmp
OUTDIR=out


if [ ! -f $CCJAR ]; then
	# if $CCJAR file does not exist, search current directory for CC
	CCJAR=`find *closure*compiler*.jar | tail -1`
fi

function deldir {
	if [ -d "$1" ]; then
		rm -r "$1"
	fi
}

function ensureDir {
	if [ ! -d "$1" ]; then
		mkdir "$1"
	fi
}

function catAllSrc {
	cat "$TMPDIR/version.js" "$OPACJSDIR/Queue.js" "$OPACJSDIR/BigDec.js" "$OPACJSDIR/OpaDef.js" "$OPACJSDIR/PartialParser.js" "$OPACJSDIR/Serializer.js" "$OPACJSDIR/OpaUtils.js" "$OPACJSDIR/EventClient.js" >> $1
}


deldir $OUTDIR
mkdir $OUTDIR

deldir $TMPDIR
mkdir $TMPDIR


if [[ -z "$VERSION" ]]; then
	VERSION=`git describe --tags --long --dirty 2> /dev/null || echo $(cat version.txt)-dev`
fi

printf "var VERSION = \"$VERSION\";\n\n" >> "$TMPDIR/version.js"


printf "var BigInteger = (function(){\n" > "$TMPDIR/jsbn.js"
cat "$LIBDIR/jsbn/jsbn.js" "$LIBDIR/jsbn/jsbn2.js" >> "$TMPDIR/jsbn.js"
printf "\nreturn BigInteger;\n}());\n" >> "$TMPDIR/jsbn.js"


if [ -f $CCJAR ]; then
	# TODO: store closure compiler version in source somewhere?
	java -jar "$CCJAR" --js "$TMPDIR/jsbn.js" --js_output_file "$TMPDIR/jsbn.min.js"
	java -jar "$CCJAR" --js "browser.head.js" "$TMPDIR/version.js" "$OPACJSDIR/*.js" "browser.foot.js" --externs "biginteger.externs.js" --js_output_file "$TMPDIR/bundle.min.js" --rewrite_polyfills=false --assume_function_wrapper --extra_annotation_name callback --extra_annotation_name hideconstructor -W VERBOSE

	printf "// Minimized and bundled source code for opatomic client. see https://github.com/opatomic/opac-js for more info\n\n" >> "$OUTDIR/opac.browser.min.js"
	printf "/* BigInteger (http://www-cs-students.stanford.edu/~tjw/jsbn/) LICENSE file: */\n" >> "$OUTDIR/opac.browser.min.js"
	cat "$LIBDIR/jsbn/LICENSE" >> "$OUTDIR/opac.browser.min.js"
	printf "\n\n(function(){" >> "$OUTDIR/opac.browser.min.js"
	cat "$TMPDIR/jsbn.min.js" "$TMPDIR/bundle.min.js" >> "$OUTDIR/opac.browser.min.js"
	printf "}());\n" >> "$OUTDIR/opac.browser.min.js"
else
	echo "CCJAR not found. browser build will not minimize"
fi


printf "// Bundled source code for opatomic client. see https://github.com/opatomic/opac-js for more info\n" > "$OUTDIR/opac.browser.js"
printf "(function(){\n" >> "$OUTDIR/opac.browser.js"
cat "browser.head.js" >> "$OUTDIR/opac.browser.js"
printf "// BigInteger (http://www-cs-students.stanford.edu/~tjw/jsbn/):\n" >> "$OUTDIR/opac.browser.js"
cat "$LIBDIR/jsbn/LICENSE" "$TMPDIR/jsbn.js" >> "$OUTDIR/opac.browser.js"
printf "\n\n" >> "$OUTDIR/opac.browser.js"
catAllSrc "$OUTDIR/opac.browser.js"
cat "browser.foot.js" >> "$OUTDIR/opac.browser.js"
printf "})();\n" >> "$OUTDIR/opac.browser.js"


ensureDir "$OUTDIR/node"
cat "node.head.js" > "$OUTDIR/node/opac.node.js"
catAllSrc "$OUTDIR/node/opac.node.js"
cat "node.foot.js" >> "$OUTDIR/node/opac.node.js"
sed -e "s/\\\$VERSION/$VERSION/" "package.json" > "$OUTDIR/node/package.json"
cp "../README.md" "$OUTDIR/node/README.md"


deldir $TMPDIR


# TODO: run some tests!!!

deldir "../docs"
jsdoc "$OPACJSDIR/" -d "../docs/" -c "jsdoc.conf.json"
deldir "../docs/fonts"


