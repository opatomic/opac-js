#!/bin/bash

# to minimize browser build, must have java 8+ installed, download
# closure compiler, and set $CCJAR to the jar file's path.
#  https://github.com/google/closure-compiler

# TODO: support running closure compiler from within node?

CCJAR=~/Downloads/closure.compiler/closure-compiler-v20180204.jar
OPACJSDIR=../src
LIBDIR=../lib
TMPDIR=tmp


if [ ! -f $CCJAR ]; then
	# if $CCJAR file does not exist, search current directory for CC
	CCJAR=`find *closure*compiler*.jar | tail -1`
fi

function deldir {
	if [ -d "$1" ]; then
		rm -r "$1"
	fi
}

function ensureDir {
	if [ ! -d "$1" ]; then
		mkdir "$1"
	fi
}

function writeVersion {
	printf "const VERSION = \"$VERSION\";\n\n" >> "$1"
}

function catHead {
	printf "// #### Contents of " >> "$2"
	basename "$1" | tr "\n" " " >> "$2"
	printf "####\n\n" >> "$2"
	cat "$1" >> "$2"
}

function catObjClosure {
	printf "var $1 = (function(){\n" >> $3
	catHead $2 $3
	printf "return $1;\n}());\n\n" >> $3
}


ensureDir "browser"
ensureDir "node"

deldir $TMPDIR
mkdir $TMPDIR


if [[ $# -eq 1 && $1 = "--publish" ]]; then
	VERSUFF=
else
	VERSUFF=-dev
fi

VERSION=`cat version.txt`
VERSION=$VERSION$VERSUFF


writeVersion "$TMPDIR/bundle.js"
catObjClosure "BigDec" "$OPACJSDIR/BigDec.js" "$TMPDIR/bundle.js"
catObjClosure "OpaDef" "$OPACJSDIR/OpaDef.js" "$TMPDIR/bundle.js"
catObjClosure "PartialParser" "$OPACJSDIR/PartialParser.js" "$TMPDIR/bundle.js"
catObjClosure "Serializer" "$OPACJSDIR/Serializer.js" "$TMPDIR/bundle.js"
catHead "$OPACJSDIR/OpaUtils.js" "$TMPDIR/bundle.js"
catObjClosure "StreamClient" "$OPACJSDIR/StreamClient.js" "$TMPDIR/bundle.js"


printf "var Deque = (function(){var module = {}; (function(){\n" > "$TMPDIR/deque.js"
cat "$LIBDIR/deque/deque.js" >> "$TMPDIR/deque.js"
printf "\n}());return module.exports;}());" >> "$TMPDIR/deque.js"

printf "var BigInteger = (function(){\n" > "$TMPDIR/jsbn.js"
cat "$LIBDIR/jsbn/jsbn.js" "$LIBDIR/jsbn/jsbn2.js" >> "$TMPDIR/jsbn.js"
printf "\nreturn BigInteger;\n}());\n" >> "$TMPDIR/jsbn.js"


rm "browser/opac.browser.min.js"
if [ -f $CCJAR ]; then
	java -jar "$CCJAR" --js "browser.head.js" "$TMPDIR/deque.js" "$TMPDIR/jsbn.js" "$TMPDIR/bundle.js" "browser.foot.js" --js_output_file "$TMPDIR/bundle.min.js" --rewrite_polyfills=false --isolation_mode IIFE

	printf "// Minimized and bundled source code for opatomic client. see https://github.com/opatomic/opac-js for more info\n\n" >> "browser/opac.browser.min.js"
	printf "/* Deque (https://github.com/petkaantonov/deque) LICENSE file:\n" >> "browser/opac.browser.min.js"
	cat "$LIBDIR/deque/LICENSE" >> "browser/opac.browser.min.js"
	printf "*/\n" >> "browser/opac.browser.min.js"
	printf "\n\n/* BigInteger (http://www-cs-students.stanford.edu/~tjw/jsbn/) LICENSE file: */\n" >> "browser/opac.browser.min.js"
	cat "$LIBDIR/jsbn/LICENSE" >> "browser/opac.browser.min.js"
	printf "\n\n" >> "browser/opac.browser.min.js"
	cat "$TMPDIR/bundle.min.js" >> "browser/opac.browser.min.js"
else
	echo "CCJAR not found. browser build will not minimize"
fi


printf "// Bundled source code for opatomic client. see https://github.com/opatomic/opac-js for more info\n" > "browser/opac.browser.js"
printf "(function(){\n" >> "browser/opac.browser.js"
cat "browser.head.js" >> "browser/opac.browser.js"
printf "// Deque (https://github.com/petkaantonov/deque):\n" >> "browser/opac.browser.js"
cat "$TMPDIR/deque.js" >> "browser/opac.browser.js"
printf "\n\n// BigInteger (http://www-cs-students.stanford.edu/~tjw/jsbn/):\n" >> "browser/opac.browser.js"
cat "$LIBDIR/jsbn/LICENSE" "$TMPDIR/jsbn.js" >> "browser/opac.browser.js"
printf "\n\n" >> "browser/opac.browser.js"
cat "$TMPDIR/bundle.js" "browser.foot.js" >> "browser/opac.browser.js"
printf "})();\n" >> "browser/opac.browser.js"


cat "node.head.js" > "node/opac.node.js"
cat "$TMPDIR/bundle.js" "node.foot.js" >> "node/opac.node.js"
sed -e "s/\\\$VERSION/$VERSION/" "package.json" > "node/package.json"
cp "../README.md" "node/README.md"


deldir $TMPDIR


# TODO: run some tests!!!

# TODO: generate docs?


