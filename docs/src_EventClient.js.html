<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>src/EventClient.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    <input type="text" id="nav-search" placeholder="Search" />
    
    <h2><a href="index.html">Home</a></h2><h2><a href="https://github.com/opatomic/opac-js" target="_blank" class="menu-item" id="repository" >Github repo</a></h2><h3>Classes</h3><ul><li><a href="BigDec.html">BigDec</a><ul class='members'><li data-type='member' style='display: none;'><a href="BigDec.html#.ONE">ONE</a></li><li data-type='member' style='display: none;'><a href="BigDec.html#.ROUND_CEILING">ROUND_CEILING</a></li><li data-type='member' style='display: none;'><a href="BigDec.html#.ROUND_DOWN">ROUND_DOWN</a></li><li data-type='member' style='display: none;'><a href="BigDec.html#.ROUND_FLOOR">ROUND_FLOOR</a></li><li data-type='member' style='display: none;'><a href="BigDec.html#.ROUND_HALF_DOWN">ROUND_HALF_DOWN</a></li><li data-type='member' style='display: none;'><a href="BigDec.html#.ROUND_HALF_EVEN">ROUND_HALF_EVEN</a></li><li data-type='member' style='display: none;'><a href="BigDec.html#.ROUND_HALF_UP">ROUND_HALF_UP</a></li><li data-type='member' style='display: none;'><a href="BigDec.html#.ROUND_UNNECESSARY">ROUND_UNNECESSARY</a></li><li data-type='member' style='display: none;'><a href="BigDec.html#.ROUND_UP">ROUND_UP</a></li><li data-type='member' style='display: none;'><a href="BigDec.html#.TEN">TEN</a></li><li data-type='member' style='display: none;'><a href="BigDec.html#.ZERO">ZERO</a></li></ul><ul class='methods'><li data-type='method' style='display: none;'><a href="BigDec.html#abs">abs</a></li><li data-type='method' style='display: none;'><a href="BigDec.html#add">add</a></li><li data-type='method' style='display: none;'><a href="BigDec.html#byteValue">byteValue</a></li><li data-type='method' style='display: none;'><a href="BigDec.html#byteValueExact">byteValueExact</a></li><li data-type='method' style='display: none;'><a href="BigDec.html#clone">clone</a></li><li data-type='method' style='display: none;'><a href="BigDec.html#compareTo">compareTo</a></li><li data-type='method' style='display: none;'><a href="BigDec.html#divide">divide</a></li><li data-type='method' style='display: none;'><a href="BigDec.html#divideAndRemainder">divideAndRemainder</a></li><li data-type='method' style='display: none;'><a href="BigDec.html#divideToIntegralValue">divideToIntegralValue</a></li><li data-type='method' style='display: none;'><a href="BigDec.html#equals">equals</a></li><li data-type='method' style='display: none;'><a href="BigDec.html#intValue">intValue</a></li><li data-type='method' style='display: none;'><a href="BigDec.html#intValueExact">intValueExact</a></li><li data-type='method' style='display: none;'><a href="BigDec.html#max">max</a></li><li data-type='method' style='display: none;'><a href="BigDec.html#min">min</a></li><li data-type='method' style='display: none;'><a href="BigDec.html#movePointLeft">movePointLeft</a></li><li data-type='method' style='display: none;'><a href="BigDec.html#movePointRight">movePointRight</a></li><li data-type='method' style='display: none;'><a href="BigDec.html#multiply">multiply</a></li><li data-type='method' style='display: none;'><a href="BigDec.html#negate">negate</a></li><li data-type='method' style='display: none;'><a href="BigDec.html#pow">pow</a></li><li data-type='method' style='display: none;'><a href="BigDec.html#precision">precision</a></li><li data-type='method' style='display: none;'><a href="BigDec.html#remainder">remainder</a></li><li data-type='method' style='display: none;'><a href="BigDec.html#scale">scale</a></li><li data-type='method' style='display: none;'><a href="BigDec.html#scaleByPowerOfTen">scaleByPowerOfTen</a></li><li data-type='method' style='display: none;'><a href="BigDec.html#setScale">setScale</a></li><li data-type='method' style='display: none;'><a href="BigDec.html#shortValue">shortValue</a></li><li data-type='method' style='display: none;'><a href="BigDec.html#shortValueExact">shortValueExact</a></li><li data-type='method' style='display: none;'><a href="BigDec.html#signum">signum</a></li><li data-type='method' style='display: none;'><a href="BigDec.html#stripTrailingZeros">stripTrailingZeros</a></li><li data-type='method' style='display: none;'><a href="BigDec.html#subtract">subtract</a></li><li data-type='method' style='display: none;'><a href="BigDec.html#toBigInteger">toBigInteger</a></li><li data-type='method' style='display: none;'><a href="BigDec.html#toBigIntegerExact">toBigIntegerExact</a></li><li data-type='method' style='display: none;'><a href="BigDec.html#toEngineeringString">toEngineeringString</a></li><li data-type='method' style='display: none;'><a href="BigDec.html#toPlainString">toPlainString</a></li><li data-type='method' style='display: none;'><a href="BigDec.html#toString">toString</a></li><li data-type='method' style='display: none;'><a href="BigDec.html#ulp">ulp</a></li><li data-type='method' style='display: none;'><a href="BigDec.html#unscaledValue">unscaledValue</a></li></ul></li><li><a href="BigInteger.html">BigInteger</a><ul class='members'><li data-type='member' style='display: none;'><a href="BigInteger.html#.ONE">ONE</a></li><li data-type='member' style='display: none;'><a href="BigInteger.html#.ZERO">ZERO</a></li></ul><ul class='methods'><li data-type='method' style='display: none;'><a href="BigInteger.html#abs">abs</a></li><li data-type='method' style='display: none;'><a href="BigInteger.html#add">add</a></li><li data-type='method' style='display: none;'><a href="BigInteger.html#and">and</a></li><li data-type='method' style='display: none;'><a href="BigInteger.html#andNot">andNot</a></li><li data-type='method' style='display: none;'><a href="BigInteger.html#bitCount">bitCount</a></li><li data-type='method' style='display: none;'><a href="BigInteger.html#bitLength">bitLength</a></li><li data-type='method' style='display: none;'><a href="BigInteger.html#byteValue">byteValue</a></li><li data-type='method' style='display: none;'><a href="BigInteger.html#clearBit">clearBit</a></li><li data-type='method' style='display: none;'><a href="BigInteger.html#compareTo">compareTo</a></li><li data-type='method' style='display: none;'><a href="BigInteger.html#divide">divide</a></li><li data-type='method' style='display: none;'><a href="BigInteger.html#divideAndRemainder">divideAndRemainder</a></li><li data-type='method' style='display: none;'><a href="BigInteger.html#flipBit">flipBit</a></li><li data-type='method' style='display: none;'><a href="BigInteger.html#gcd">gcd</a></li><li data-type='method' style='display: none;'><a href="BigInteger.html#getLowestSetBit">getLowestSetBit</a></li><li data-type='method' style='display: none;'><a href="BigInteger.html#intValue">intValue</a></li><li data-type='method' style='display: none;'><a href="BigInteger.html#max">max</a></li><li data-type='method' style='display: none;'><a href="BigInteger.html#min">min</a></li><li data-type='method' style='display: none;'><a href="BigInteger.html#mod">mod</a></li><li data-type='method' style='display: none;'><a href="BigInteger.html#modInverse">modInverse</a></li><li data-type='method' style='display: none;'><a href="BigInteger.html#modPow">modPow</a></li><li data-type='method' style='display: none;'><a href="BigInteger.html#multiply">multiply</a></li><li data-type='method' style='display: none;'><a href="BigInteger.html#negate">negate</a></li><li data-type='method' style='display: none;'><a href="BigInteger.html#not">not</a></li><li data-type='method' style='display: none;'><a href="BigInteger.html#or">or</a></li><li data-type='method' style='display: none;'><a href="BigInteger.html#pow">pow</a></li><li data-type='method' style='display: none;'><a href="BigInteger.html#remainder">remainder</a></li><li data-type='method' style='display: none;'><a href="BigInteger.html#setBit">setBit</a></li><li data-type='method' style='display: none;'><a href="BigInteger.html#shiftLeft">shiftLeft</a></li><li data-type='method' style='display: none;'><a href="BigInteger.html#shiftRight">shiftRight</a></li><li data-type='method' style='display: none;'><a href="BigInteger.html#shortValue">shortValue</a></li><li data-type='method' style='display: none;'><a href="BigInteger.html#signum">signum</a></li><li data-type='method' style='display: none;'><a href="BigInteger.html#subtract">subtract</a></li><li data-type='method' style='display: none;'><a href="BigInteger.html#testBit">testBit</a></li><li data-type='method' style='display: none;'><a href="BigInteger.html#toByteArray">toByteArray</a></li><li data-type='method' style='display: none;'><a href="BigInteger.html#toString">toString</a></li><li data-type='method' style='display: none;'><a href="BigInteger.html#xor">xor</a></li></ul></li><li><a href="ClientConfig.html">ClientConfig</a><ul class='methods'><li data-type='method' style='display: none;'><a href="ClientConfig.html#clientErrorHandler">clientErrorHandler</a></li><li data-type='method' style='display: none;'><a href="ClientConfig.html#uncaughtExceptionHandler">uncaughtExceptionHandler</a></li><li data-type='method' style='display: none;'><a href="ClientConfig.html#unknownIdHandler">unknownIdHandler</a></li></ul></li><li><a href="EventClient.html">EventClient</a><ul class='methods'><li data-type='method' style='display: none;'><a href="EventClient.html#call">call</a></li><li data-type='method' style='display: none;'><a href="EventClient.html#callA">callA</a></li><li data-type='method' style='display: none;'><a href="EventClient.html#callID">callID</a></li><li data-type='method' style='display: none;'><a href="EventClient.html#flush">flush</a></li><li data-type='method' style='display: none;'><a href="EventClient.html#onClose">onClose</a></li><li data-type='method' style='display: none;'><a href="EventClient.html#onRecv">onRecv</a></li><li data-type='method' style='display: none;'><a href="EventClient.html#registerCB">registerCB</a></li></ul></li><li><a href="OpaDef.html">OpaDef</a><ul class='members'><li data-type='member' style='display: none;'><a href="OpaDef.html#.ARRAYEND">ARRAYEND</a></li><li data-type='member' style='display: none;'><a href="OpaDef.html#.ARRAYSTART">ARRAYSTART</a></li><li data-type='member' style='display: none;'><a href="OpaDef.html#.BINLPVI">BINLPVI</a></li><li data-type='member' style='display: none;'><a href="OpaDef.html#.EMPTYARRAY">EMPTYARRAY</a></li><li data-type='member' style='display: none;'><a href="OpaDef.html#.EMPTYBIN">EMPTYBIN</a></li><li data-type='member' style='display: none;'><a href="OpaDef.html#.EMPTYSTR">EMPTYSTR</a></li><li data-type='member' style='display: none;'><a href="OpaDef.html#.ERR_CLOSED">ERR_CLOSED</a></li><li data-type='member' style='display: none;'><a href="OpaDef.html#.FALSE">FALSE</a></li><li data-type='member' style='display: none;'><a href="OpaDef.html#.NEGBIGINT">NEGBIGINT</a></li><li data-type='member' style='display: none;'><a href="OpaDef.html#.NEGINF">NEGINF</a></li><li data-type='member' style='display: none;'><a href="OpaDef.html#.NEGNEGBIGDEC">NEGNEGBIGDEC</a></li><li data-type='member' style='display: none;'><a href="OpaDef.html#.NEGNEGVARDEC">NEGNEGVARDEC</a></li><li data-type='member' style='display: none;'><a href="OpaDef.html#.NEGPOSBIGDEC">NEGPOSBIGDEC</a></li><li data-type='member' style='display: none;'><a href="OpaDef.html#.NEGPOSVARDEC">NEGPOSVARDEC</a></li><li data-type='member' style='display: none;'><a href="OpaDef.html#.NEGVARINT">NEGVARINT</a></li><li data-type='member' style='display: none;'><a href="OpaDef.html#.NULL">NULL</a></li><li data-type='member' style='display: none;'><a href="OpaDef.html#.POSBIGINT">POSBIGINT</a></li><li data-type='member' style='display: none;'><a href="OpaDef.html#.POSINF">POSINF</a></li><li data-type='member' style='display: none;'><a href="OpaDef.html#.POSNEGBIGDEC">POSNEGBIGDEC</a></li><li data-type='member' style='display: none;'><a href="OpaDef.html#.POSNEGVARDEC">POSNEGVARDEC</a></li><li data-type='member' style='display: none;'><a href="OpaDef.html#.POSPOSBIGDEC">POSPOSBIGDEC</a></li><li data-type='member' style='display: none;'><a href="OpaDef.html#.POSPOSVARDEC">POSPOSVARDEC</a></li><li data-type='member' style='display: none;'><a href="OpaDef.html#.POSVARINT">POSVARINT</a></li><li data-type='member' style='display: none;'><a href="OpaDef.html#.SORTMAX">SORTMAX</a></li><li data-type='member' style='display: none;'><a href="OpaDef.html#.SORTMAX_OBJ">SORTMAX_OBJ</a></li><li data-type='member' style='display: none;'><a href="OpaDef.html#.STRLPVI">STRLPVI</a></li><li data-type='member' style='display: none;'><a href="OpaDef.html#.TRUE">TRUE</a></li><li data-type='member' style='display: none;'><a href="OpaDef.html#.UNDEFINED">UNDEFINED</a></li><li data-type='member' style='display: none;'><a href="OpaDef.html#.ZERO">ZERO</a></li></ul></li><li><a href="PartialParser.html">PartialParser</a><ul class='methods'><li data-type='method' style='display: none;'><a href="PartialParser.html#parseNext">parseNext</a></li></ul></li><li><a href="PartialParser.Buff.html">PartialParser.Buff</a></li><li><a href="Queue.html">Queue</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Queue.html#push">push</a></li><li data-type='method' style='display: none;'><a href="Queue.html#shift">shift</a></li><li data-type='method' style='display: none;'><a href="Queue.html#size">size</a></li></ul></li><li><a href="Serializer.html">Serializer</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Serializer.html#flush">flush</a></li><li data-type='method' style='display: none;'><a href="Serializer.html#write">write</a></li><li data-type='method' style='display: none;'><a href="Serializer.html#write1">write1</a></li><li data-type='method' style='display: none;'><a href="Serializer.html#writeArray">writeArray</a></li><li data-type='method' style='display: none;'><a href="Serializer.html#writeNumber">writeNumber</a></li><li data-type='method' style='display: none;'><a href="Serializer.html#writeObject">writeObject</a></li><li data-type='method' style='display: none;'><a href="Serializer.html#writeString">writeString</a></li></ul></li></ul><h3>Interfaces</h3><ul><li><a href="IWriter.html">IWriter</a><ul class='methods'><li data-type='method' style='display: none;'><a href="IWriter.html#close">close</a></li><li data-type='method' style='display: none;'><a href="IWriter.html#flush">flush</a></li><li data-type='method' style='display: none;'><a href="IWriter.html#write">write</a></li></ul></li></ul><h3>Global</h3><ul><li><a href="global.html#opaType">opaType</a></li><li><a href="global.html#ResponseCallback">ResponseCallback</a></li><li><a href="global.html#RoundingMode">RoundingMode</a></li><li><a href="global.html#stringify">stringify</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">src/EventClient.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/*
 * Copyright 2018-2019 Opatomic
 * Open sourced with ISC license. Refer to LICENSE for details.
 */

// dependencies: STRENC PartialParser Serializer Queue Map

/**
 * @ignore
 * @typedef {function(*, *=):undefined}
 */
var ResponseCallback; // eslint-disable-line no-unused-vars

/**
 * @callback ResponseCallback
 * @param {*}  error  - Error or null if no error occurred.
 * @param {*=} result - The result of the operation if error didn't occur (error is null).
 */


/**
 * @constructor
 * @template K,V
 * @extends {Map&lt;K,V>}
 * @ignore
 */
var IdMap = function() {};
if (typeof Map == "function") {
	IdMap = Map;
} else {
	/**
	 * @constructor
	 * @template K,V
	 * @extends {Map&lt;K,V>}
	 * @ignore
	 */
	IdMap = function() {
		// note: this Map implementation is designed to work with keys that are strings or integers
		//   it is not a proper polyfill for ES6 Map
		/** @type {!Object} */
		this.vals = {};
	};

	/**
	 * @param {*} key
	 * @return {V}
	 * @override
	 */
	IdMap.prototype.get = function(key) {
		return this.vals[key];
	};

	/**
	 * @param {K} key
	 * @param {V} val
	 * @override
	 */
	IdMap.prototype.set = function(key, val) {
		this.vals[key] = val;
	};

	/**
	 * @param {*} key
	 * @return {boolean}
	 * @override
	 */
	IdMap.prototype.delete = function(key) {
		var exists = key in this.vals;
		delete this.vals[key];
		return exists;
	};

	/**
	 * @param {function(V, K, !IdMap)} cb
	 * @override
	 */
	IdMap.prototype.forEach = function(cb) {
		for (var p in this.vals) {
			cb(this.vals[p], p, this);
		}
	};

	/**
	 * @override
	 */
	IdMap.prototype.clear = function() {
		this.vals = {};
	};
}

/**
 * @param {*} v
 * @ignore
 */
function consoleLog(v) {
	if (console &amp;&amp; console.log) {
		console.log(v);
	}
}

/**
 * @param {!Object} obj
 * @param {!Function} cb
 * @param {?Array=} args
 * @ignore
 */
function invokeCallback(obj, cb, args) {
	try {
		if (cb != null) {
			cb.apply(obj, args);
		}
	} catch (e) {
		// TODO: don't log? have another callback?
		consoleLog(e);
	}
}

/**
 * @param {!EventClient} c
 * @param {*} err
 * @ignore
 */
function clientError(c, err) {
	invokeCallback(c.mConfig, c.mConfig.clientErrorHandler, [err]);
	invokeCallback(c.o, c.o.close);
}

/**
 * Configurable client options
 * @constructor
 */
function ClientConfig() {
	/**
	 * Size of the serializer buffer in bytes
	 * @type {number}
	 */
	this.sendBuffLen = 4096;
}

/**
 * Callback to invoke when a response is received without a registered callback.
 * @param {*}  id     - Response's async ID
 * @param {*}  result - The result of the operation if error didn't occur (error is null).
 * @param {*=} error  - Error or null if no error occurred.
 */
ClientConfig.prototype.unknownIdHandler = function(id, result, error) {
	consoleLog("unknown async id: " + opaStringify(id));
};

/**
 * Callback to invoke when an uncaught exception occurs.
 * @param {*}  exception - Exception that was caught
 * @param {*=} context   - An object representing the context of the exception
 */
ClientConfig.prototype.uncaughtExceptionHandler = function(exception, context) {
	exception = exception || "";
	consoleLog("uncaught exception: " + exception);
};

/**
 * Callback to invoke when an internal error occurs in the client. Examples could include parse
 * errors or serialization errors.
 * @param {*}  exception - Exception that was caught
 * @param {*=} context   - An object representing the context of the exception
 */
ClientConfig.prototype.clientErrorHandler = function(exception, context) {
	exception = exception || "";
	consoleLog("client error: " + exception);
};

/**
 * Create new EventClient
 * @constructor
 * @param {!IWriter} o - Object that has a write(), flush(), and close() method.
 * @param {?ClientConfig=} cfg - Client options. See ClientConfig for details.
 */
function EventClient(o, cfg) {
	cfg = cfg || new ClientConfig();
	/** @type {!IWriter} */
	this.o = o;
	/** @type {!Serializer} */
	this.s = new Serializer(o, cfg.sendBuffLen);
	/** @type {number} */
	this.id = 0;
	/** @type {!Queue&lt;!ResponseCallback>} */
	this.mMainCallbacks = new Queue();
	/** @type {!Map&lt;*,!ResponseCallback>} */
	this.mAsyncCallbacks = new IdMap();
	/** @type {!PartialParser} */
	this.mParser = new PartialParser();
	/** @type {!PartialParser.Buff} */
	this.mBuff = new PartialParser.Buff();
	/** @type {number|null} */
	this.mTimeout = null;
	/** @type {boolean} */
	this.mFlushScheduled = false;
	/** @type {!ClientConfig} */
	this.mConfig = cfg;
}

(function() {

/**
 * @param {!EventClient} c
 */
function flushInternal(c) {
	try {
		if (c.mTimeout !== null) {
			clearTimeout(c.mTimeout);
			c.mFlushScheduled = false;
			c.mTimeout = null;
		}
		c.s.flush();
	} catch (e) {
		clientError(c, e);
	}
}

/**
 * @param {!EventClient} c
 */
function schedTimeout(c) {
	if (!c.mFlushScheduled) {
		c.mTimeout = NEXTTICK(function() {
			c.mFlushScheduled = false;
			c.mTimeout = null;
			flushInternal(c);
		});
		c.mFlushScheduled = true;
	}
}

/**
 * Send all buffered requests.
 */
EventClient.prototype.flush = function() {
	flushInternal(this);
};

/**
 * @param {!EventClient} c
 * @param {*} asyncid
 * @param {string} cmd
 * @param {?Array=} args
 */
function writeRequest(c, asyncid, cmd, args) {
	try {
		// note: The following function calls could throw an exception - especially since objects
		//       can define a toOpaSO() method and could throw from within caller's codebase.
		c.s.write1(CH_ARRAYSTART);
		c.s.writeObject(asyncid);
		c.s.writeObject(cmd);
		if (args) {
			for (var i = 0; i &lt; args.length; ++i) {
				c.s.writeObject(args[i]);
			}
		}
		c.s.write1(CH_ARRAYEND);
		schedTimeout(c);
	} catch (e) {
		clientError(c, e);
	}
}

/**
 * Sends the specified command and args to the server. Invokes the specified callback when a response is received.
 * @param {string} cmd - The command to run
 * @param {?Array=} args - The parameters for the command
 * @param {?ResponseCallback=} cb - A callback function to invoke when the response is received
 */
EventClient.prototype.call = function(cmd, args, cb) {
	if (cb) {
		this.mMainCallbacks.push(cb);
		writeRequest(this, null, cmd, args);
	} else {
		// no callback function: send false as asyncid so server does not send a response
		writeRequest(this, false, cmd, args);
	}
};

/**
 * @param {!EventClient} c
 * @param {*} id
 * @param {?ResponseCallback} cb
 */
function regCB(c, id, cb) {
	if (cb == null) {
		c.mAsyncCallbacks.delete(id);
	} else {
		c.mAsyncCallbacks.set(id, cb);
	}
}

/**
 * Register a callback to an async id that can be used by callID().
 * @param {string} id - Async ID: must be a string.
 * @param {?ResponseCallback} cb - A callback function to invoke when each response is received.
                                   Use null to remove registered callback.
 */
EventClient.prototype.registerCB = function(id, cb) {
	if (typeof id != "string") {
		throw new Error("id must be a string");
	}
	regCB(this, id, cb);
};

/**
 * Run specified command on the server with a specified async id. Any responses to the command
 * will invoke the callback that was given as a parameter to registerCB().
 * @param {string} id - Async id
 * @param {string} cmd - The command to run
 * @param {!Array} args - The parameters for the command
 */
EventClient.prototype.callID = function(id, cmd, args) {
	if (typeof id != "string") {
		throw new Error("id must be a string");
	}
	writeRequest(this, id, cmd, args);
};

/**
 * @param {!EventClient} c
 * @param {!ResponseCallback} cb
 * @param {*} err
 * @param {*=} result
 */
function invokeResponseCallback(c, cb, err, result) {
	try {
		cb(err, result);
	} catch (e) {
		invokeCallback(c.mConfig, c.mConfig.uncaughtExceptionHandler, [e]);
	}
}

/**
 * Sends the specified command and args to the server with an async id. Using an async id indicates to the
 * server that the operation response can be sent out of order. Invokes the specified callback when a
 * response is received.
 * @param {string} cmd - The command to run
 * @param {!Array} args - The parameters for the command
 * @param {!ResponseCallback} cb - A callback function to invoke when the response is received
 */
EventClient.prototype.callA = function(cmd, args, cb) {
	var c = this;
	var id = ++c.id;
	regCB(c, id, function(err, result) {
		regCB(c, id, null);
		invokeResponseCallback(c, cb, err, result);
	});
	writeRequest(c, id, cmd, args);
};

/**
 * @param {!EventClient} c
 * @param {!Array&lt;*>} msg
 */
function onResponse(c, msg) {
	if (msg.length &lt; 2 || msg.length > 3) {
		throw new Error("response array is wrong length");
	}
	var cb;
	var id = msg[0];
	if (id !== null &amp;&amp; id !== undefined) {
		cb = c.mAsyncCallbacks.get(id);
		if (cb != null &amp;&amp; isInteger(id) &amp;&amp; (/** @type {number} */(id) > 0)) {
			c.mAsyncCallbacks.delete(id);
		}
	} else {
		cb = c.mMainCallbacks.shift();
	}

	if (cb != null) {
		invokeResponseCallback(c, cb, msg.length > 2 ? msg[2] : null, msg[1]);
	} else {
		if (id === null || id === undefined) {
			throw new Error("received extraneous null-async-id response");
		}
		invokeCallback(c.mConfig, c.mConfig.unknownIdHandler, msg);
	}
}

/**
 * Call this method when more data has arrived from server. Buffer will be parsed
 * and callbacks invoked for each complete response received.
 * @param {!Uint8Array} b - Byte buffer containing data to parse
 */
EventClient.prototype.onRecv = function(b) {
	var c = this;
	try {
		c.mBuff.data = b;
		c.mBuff.idx = 0;
		c.mBuff.len = b.length;
		while (true) {
			var obj = c.mParser.parseNext(c.mBuff);
			if (obj == null) {
				break;
			}
			onResponse(c, obj);
		}
	} catch (e) {
		clientError(c, e);
	}
};

/**
 * Call this method when connection is closed. All request callbacks that have not received a response
 * will be notified of failure. Every persistent async callback will also be notified of failure.
 */
EventClient.prototype.onClose = function() {
	var c = this;
	var tmp = c.mMainCallbacks;
	var cbArgs = [OpaDef.ERR_CLOSED];
	while (tmp.size() > 0) {
		invokeResponseCallback(c, tmp.shift(), cbArgs);
	}

	tmp = c.mAsyncCallbacks;
	tmp.forEach(function(val, key, map) {
		invokeResponseCallback(c, val, cbArgs);
	});
	tmp.clear();
};

}());

</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.10</a> using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>

<script src="scripts/search.js" defer></script>


<script src="scripts/collapse.js" defer></script>


</body>
</html>
