<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>src/Serializer.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    <input type="text" id="nav-search" placeholder="Search" />
    
    <h2><a href="index.html">Home</a></h2><h2><a href="https://github.com/opatomic/opac-js" target="_blank" class="menu-item" id="repository" >Github repo</a></h2><h3>Classes</h3><ul><li><a href="BigDec.html">BigDec</a><ul class='members'><li data-type='member' style='display: none;'><a href="BigDec.html#.ONE">ONE</a></li><li data-type='member' style='display: none;'><a href="BigDec.html#.ROUND_CEILING">ROUND_CEILING</a></li><li data-type='member' style='display: none;'><a href="BigDec.html#.ROUND_DOWN">ROUND_DOWN</a></li><li data-type='member' style='display: none;'><a href="BigDec.html#.ROUND_FLOOR">ROUND_FLOOR</a></li><li data-type='member' style='display: none;'><a href="BigDec.html#.ROUND_HALF_DOWN">ROUND_HALF_DOWN</a></li><li data-type='member' style='display: none;'><a href="BigDec.html#.ROUND_HALF_EVEN">ROUND_HALF_EVEN</a></li><li data-type='member' style='display: none;'><a href="BigDec.html#.ROUND_HALF_UP">ROUND_HALF_UP</a></li><li data-type='member' style='display: none;'><a href="BigDec.html#.ROUND_UNNECESSARY">ROUND_UNNECESSARY</a></li><li data-type='member' style='display: none;'><a href="BigDec.html#.ROUND_UP">ROUND_UP</a></li><li data-type='member' style='display: none;'><a href="BigDec.html#.TEN">TEN</a></li><li data-type='member' style='display: none;'><a href="BigDec.html#.ZERO">ZERO</a></li></ul><ul class='methods'><li data-type='method' style='display: none;'><a href="BigDec.html#abs">abs</a></li><li data-type='method' style='display: none;'><a href="BigDec.html#add">add</a></li><li data-type='method' style='display: none;'><a href="BigDec.html#byteValue">byteValue</a></li><li data-type='method' style='display: none;'><a href="BigDec.html#byteValueExact">byteValueExact</a></li><li data-type='method' style='display: none;'><a href="BigDec.html#clone">clone</a></li><li data-type='method' style='display: none;'><a href="BigDec.html#compareTo">compareTo</a></li><li data-type='method' style='display: none;'><a href="BigDec.html#divide">divide</a></li><li data-type='method' style='display: none;'><a href="BigDec.html#divideAndRemainder">divideAndRemainder</a></li><li data-type='method' style='display: none;'><a href="BigDec.html#divideToIntegralValue">divideToIntegralValue</a></li><li data-type='method' style='display: none;'><a href="BigDec.html#equals">equals</a></li><li data-type='method' style='display: none;'><a href="BigDec.html#intValue">intValue</a></li><li data-type='method' style='display: none;'><a href="BigDec.html#intValueExact">intValueExact</a></li><li data-type='method' style='display: none;'><a href="BigDec.html#max">max</a></li><li data-type='method' style='display: none;'><a href="BigDec.html#min">min</a></li><li data-type='method' style='display: none;'><a href="BigDec.html#movePointLeft">movePointLeft</a></li><li data-type='method' style='display: none;'><a href="BigDec.html#movePointRight">movePointRight</a></li><li data-type='method' style='display: none;'><a href="BigDec.html#multiply">multiply</a></li><li data-type='method' style='display: none;'><a href="BigDec.html#negate">negate</a></li><li data-type='method' style='display: none;'><a href="BigDec.html#pow">pow</a></li><li data-type='method' style='display: none;'><a href="BigDec.html#precision">precision</a></li><li data-type='method' style='display: none;'><a href="BigDec.html#remainder">remainder</a></li><li data-type='method' style='display: none;'><a href="BigDec.html#scale">scale</a></li><li data-type='method' style='display: none;'><a href="BigDec.html#scaleByPowerOfTen">scaleByPowerOfTen</a></li><li data-type='method' style='display: none;'><a href="BigDec.html#setScale">setScale</a></li><li data-type='method' style='display: none;'><a href="BigDec.html#shortValue">shortValue</a></li><li data-type='method' style='display: none;'><a href="BigDec.html#shortValueExact">shortValueExact</a></li><li data-type='method' style='display: none;'><a href="BigDec.html#signum">signum</a></li><li data-type='method' style='display: none;'><a href="BigDec.html#stripTrailingZeros">stripTrailingZeros</a></li><li data-type='method' style='display: none;'><a href="BigDec.html#subtract">subtract</a></li><li data-type='method' style='display: none;'><a href="BigDec.html#toBigInteger">toBigInteger</a></li><li data-type='method' style='display: none;'><a href="BigDec.html#toBigIntegerExact">toBigIntegerExact</a></li><li data-type='method' style='display: none;'><a href="BigDec.html#toEngineeringString">toEngineeringString</a></li><li data-type='method' style='display: none;'><a href="BigDec.html#toPlainString">toPlainString</a></li><li data-type='method' style='display: none;'><a href="BigDec.html#toString">toString</a></li><li data-type='method' style='display: none;'><a href="BigDec.html#ulp">ulp</a></li><li data-type='method' style='display: none;'><a href="BigDec.html#unscaledValue">unscaledValue</a></li></ul></li><li><a href="BigInteger.html">BigInteger</a><ul class='members'><li data-type='member' style='display: none;'><a href="BigInteger.html#.ONE">ONE</a></li><li data-type='member' style='display: none;'><a href="BigInteger.html#.ZERO">ZERO</a></li></ul><ul class='methods'><li data-type='method' style='display: none;'><a href="BigInteger.html#abs">abs</a></li><li data-type='method' style='display: none;'><a href="BigInteger.html#add">add</a></li><li data-type='method' style='display: none;'><a href="BigInteger.html#and">and</a></li><li data-type='method' style='display: none;'><a href="BigInteger.html#andNot">andNot</a></li><li data-type='method' style='display: none;'><a href="BigInteger.html#bitCount">bitCount</a></li><li data-type='method' style='display: none;'><a href="BigInteger.html#bitLength">bitLength</a></li><li data-type='method' style='display: none;'><a href="BigInteger.html#byteValue">byteValue</a></li><li data-type='method' style='display: none;'><a href="BigInteger.html#clearBit">clearBit</a></li><li data-type='method' style='display: none;'><a href="BigInteger.html#compareTo">compareTo</a></li><li data-type='method' style='display: none;'><a href="BigInteger.html#divide">divide</a></li><li data-type='method' style='display: none;'><a href="BigInteger.html#divideAndRemainder">divideAndRemainder</a></li><li data-type='method' style='display: none;'><a href="BigInteger.html#flipBit">flipBit</a></li><li data-type='method' style='display: none;'><a href="BigInteger.html#gcd">gcd</a></li><li data-type='method' style='display: none;'><a href="BigInteger.html#getLowestSetBit">getLowestSetBit</a></li><li data-type='method' style='display: none;'><a href="BigInteger.html#intValue">intValue</a></li><li data-type='method' style='display: none;'><a href="BigInteger.html#max">max</a></li><li data-type='method' style='display: none;'><a href="BigInteger.html#min">min</a></li><li data-type='method' style='display: none;'><a href="BigInteger.html#mod">mod</a></li><li data-type='method' style='display: none;'><a href="BigInteger.html#modInverse">modInverse</a></li><li data-type='method' style='display: none;'><a href="BigInteger.html#modPow">modPow</a></li><li data-type='method' style='display: none;'><a href="BigInteger.html#multiply">multiply</a></li><li data-type='method' style='display: none;'><a href="BigInteger.html#negate">negate</a></li><li data-type='method' style='display: none;'><a href="BigInteger.html#not">not</a></li><li data-type='method' style='display: none;'><a href="BigInteger.html#or">or</a></li><li data-type='method' style='display: none;'><a href="BigInteger.html#pow">pow</a></li><li data-type='method' style='display: none;'><a href="BigInteger.html#remainder">remainder</a></li><li data-type='method' style='display: none;'><a href="BigInteger.html#setBit">setBit</a></li><li data-type='method' style='display: none;'><a href="BigInteger.html#shiftLeft">shiftLeft</a></li><li data-type='method' style='display: none;'><a href="BigInteger.html#shiftRight">shiftRight</a></li><li data-type='method' style='display: none;'><a href="BigInteger.html#shortValue">shortValue</a></li><li data-type='method' style='display: none;'><a href="BigInteger.html#signum">signum</a></li><li data-type='method' style='display: none;'><a href="BigInteger.html#subtract">subtract</a></li><li data-type='method' style='display: none;'><a href="BigInteger.html#testBit">testBit</a></li><li data-type='method' style='display: none;'><a href="BigInteger.html#toByteArray">toByteArray</a></li><li data-type='method' style='display: none;'><a href="BigInteger.html#toString">toString</a></li><li data-type='method' style='display: none;'><a href="BigInteger.html#xor">xor</a></li></ul></li><li><a href="ClientConfig.html">ClientConfig</a><ul class='methods'><li data-type='method' style='display: none;'><a href="ClientConfig.html#clientErrorHandler">clientErrorHandler</a></li><li data-type='method' style='display: none;'><a href="ClientConfig.html#uncaughtExceptionHandler">uncaughtExceptionHandler</a></li><li data-type='method' style='display: none;'><a href="ClientConfig.html#unknownIdHandler">unknownIdHandler</a></li></ul></li><li><a href="EventClient.html">EventClient</a><ul class='methods'><li data-type='method' style='display: none;'><a href="EventClient.html#call">call</a></li><li data-type='method' style='display: none;'><a href="EventClient.html#callA">callA</a></li><li data-type='method' style='display: none;'><a href="EventClient.html#callID">callID</a></li><li data-type='method' style='display: none;'><a href="EventClient.html#flush">flush</a></li><li data-type='method' style='display: none;'><a href="EventClient.html#onClose">onClose</a></li><li data-type='method' style='display: none;'><a href="EventClient.html#onRecv">onRecv</a></li><li data-type='method' style='display: none;'><a href="EventClient.html#registerCB">registerCB</a></li></ul></li><li><a href="OpaDef.html">OpaDef</a><ul class='members'><li data-type='member' style='display: none;'><a href="OpaDef.html#.ARRAYEND">ARRAYEND</a></li><li data-type='member' style='display: none;'><a href="OpaDef.html#.ARRAYSTART">ARRAYSTART</a></li><li data-type='member' style='display: none;'><a href="OpaDef.html#.BINLPVI">BINLPVI</a></li><li data-type='member' style='display: none;'><a href="OpaDef.html#.EMPTYARRAY">EMPTYARRAY</a></li><li data-type='member' style='display: none;'><a href="OpaDef.html#.EMPTYBIN">EMPTYBIN</a></li><li data-type='member' style='display: none;'><a href="OpaDef.html#.EMPTYSTR">EMPTYSTR</a></li><li data-type='member' style='display: none;'><a href="OpaDef.html#.ERR_CLOSED">ERR_CLOSED</a></li><li data-type='member' style='display: none;'><a href="OpaDef.html#.FALSE">FALSE</a></li><li data-type='member' style='display: none;'><a href="OpaDef.html#.NEGBIGINT">NEGBIGINT</a></li><li data-type='member' style='display: none;'><a href="OpaDef.html#.NEGINF">NEGINF</a></li><li data-type='member' style='display: none;'><a href="OpaDef.html#.NEGNEGBIGDEC">NEGNEGBIGDEC</a></li><li data-type='member' style='display: none;'><a href="OpaDef.html#.NEGNEGVARDEC">NEGNEGVARDEC</a></li><li data-type='member' style='display: none;'><a href="OpaDef.html#.NEGPOSBIGDEC">NEGPOSBIGDEC</a></li><li data-type='member' style='display: none;'><a href="OpaDef.html#.NEGPOSVARDEC">NEGPOSVARDEC</a></li><li data-type='member' style='display: none;'><a href="OpaDef.html#.NEGVARINT">NEGVARINT</a></li><li data-type='member' style='display: none;'><a href="OpaDef.html#.NULL">NULL</a></li><li data-type='member' style='display: none;'><a href="OpaDef.html#.POSBIGINT">POSBIGINT</a></li><li data-type='member' style='display: none;'><a href="OpaDef.html#.POSINF">POSINF</a></li><li data-type='member' style='display: none;'><a href="OpaDef.html#.POSNEGBIGDEC">POSNEGBIGDEC</a></li><li data-type='member' style='display: none;'><a href="OpaDef.html#.POSNEGVARDEC">POSNEGVARDEC</a></li><li data-type='member' style='display: none;'><a href="OpaDef.html#.POSPOSBIGDEC">POSPOSBIGDEC</a></li><li data-type='member' style='display: none;'><a href="OpaDef.html#.POSPOSVARDEC">POSPOSVARDEC</a></li><li data-type='member' style='display: none;'><a href="OpaDef.html#.POSVARINT">POSVARINT</a></li><li data-type='member' style='display: none;'><a href="OpaDef.html#.SORTMAX">SORTMAX</a></li><li data-type='member' style='display: none;'><a href="OpaDef.html#.SORTMAX_OBJ">SORTMAX_OBJ</a></li><li data-type='member' style='display: none;'><a href="OpaDef.html#.STRLPVI">STRLPVI</a></li><li data-type='member' style='display: none;'><a href="OpaDef.html#.TRUE">TRUE</a></li><li data-type='member' style='display: none;'><a href="OpaDef.html#.UNDEFINED">UNDEFINED</a></li><li data-type='member' style='display: none;'><a href="OpaDef.html#.ZERO">ZERO</a></li></ul></li><li><a href="PartialParser.html">PartialParser</a><ul class='methods'><li data-type='method' style='display: none;'><a href="PartialParser.html#parseNext">parseNext</a></li></ul></li><li><a href="PartialParser.Buff.html">PartialParser.Buff</a></li><li><a href="Queue.html">Queue</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Queue.html#push">push</a></li><li data-type='method' style='display: none;'><a href="Queue.html#shift">shift</a></li><li data-type='method' style='display: none;'><a href="Queue.html#size">size</a></li></ul></li><li><a href="Serializer.html">Serializer</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Serializer.html#flush">flush</a></li><li data-type='method' style='display: none;'><a href="Serializer.html#write">write</a></li><li data-type='method' style='display: none;'><a href="Serializer.html#write1">write1</a></li><li data-type='method' style='display: none;'><a href="Serializer.html#writeArray">writeArray</a></li><li data-type='method' style='display: none;'><a href="Serializer.html#writeNumber">writeNumber</a></li><li data-type='method' style='display: none;'><a href="Serializer.html#writeObject">writeObject</a></li><li data-type='method' style='display: none;'><a href="Serializer.html#writeString">writeString</a></li></ul></li></ul><h3>Interfaces</h3><ul><li><a href="IWriter.html">IWriter</a><ul class='methods'><li data-type='method' style='display: none;'><a href="IWriter.html#close">close</a></li><li data-type='method' style='display: none;'><a href="IWriter.html#flush">flush</a></li><li data-type='method' style='display: none;'><a href="IWriter.html#write">write</a></li></ul></li></ul><h3>Global</h3><ul><li><a href="global.html#opaType">opaType</a></li><li><a href="global.html#ResponseCallback">ResponseCallback</a></li><li><a href="global.html#RoundingMode">RoundingMode</a></li><li><a href="global.html#stringify">stringify</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">src/Serializer.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/*
 * Copyright 2018-2019 Opatomic
 * Open sourced with ISC license. Refer to LICENSE for details.
 */

// Dependencies: BigInteger, BigDec, OpaDef, NEWBUF, STRENC

/**
 * @interface
 */
var IWriter = function() {};

/**
 * @param {!Uint8Array} buff
 * @return {boolean} false indicates caller should stop writing data; otherwise true
 */
IWriter.prototype.write = function(buff) {};

/**
 * Write all buffered bytes
 */
IWriter.prototype.flush = function() {};

/**
 * Close the stream and release all used resources
 */
IWriter.prototype.close = function() {};


/**
 * @constructor
 * @param {!IWriter} out - Where to write values
 * @param {number=} sz - Length of internal buffer
 */
var Serializer = function(out, sz) {};

(function() {

/**
 * @constructor
 * @param {!IWriter} out - Where to write values
 * @param {number=} sz - Length of internal buffer
 */
Serializer = function(out, sz) {
	if (sz &amp;&amp; sz &lt;= 10) {
		throw new Error("buffer len is too small");
	}
	/** @type {!IWriter} */
	this.o = out;
	/** @type {!Uint8Array} */
	this.b = NEWBUF(sz ? sz : 4096);
	/** @type {number} */
	this.i = 0;
	/** @type {boolean} */
	this.c = true;
};

var SURROGATE_OFFSET = 0x010000 - (0xD800 &lt;&lt; 10) - 0xDC00;
var BIMAXVARINT = new BigInteger("9223372036854775807");
var BIMINVARINT = BIMAXVARINT.negate();
var BIGINT31 = new BigInteger("7FFFFFFF", 16);

// note: potential memory leak here. keeping a temp big int object for serialization, to prevent allocations
//  it does not get cleared after use. assume memory usage will not be very large for 1 value
var TMPBI2 = new BigInteger(null);

/**
 * @param {!Serializer} s
 * @return {boolean} false indicates caller should stop writing data; otherwise true
 */
function flushBuff(s) {
	if (s.i > 0) {
		s.c = s.o.write(s.i == s.b.length ? s.b : s.b.subarray(0, s.i));
		s.i = 0;
	}
	return s.c;
}

/**
 * @param {string} s
 * @param {number} offset
 * @param {number} len
 * @return {number}
 */
function getUtf8Len(s, offset, len) {
	var end = offset + len;
	var numBytes = len;
	for (var i = offset; i &lt; end; ++i) {
		var ch = s.charCodeAt(i);
		if (ch &lt; 0x80) {
			// ascii chars are 1 byte (already accounted for)
		} else if (ch &lt; 0x800) {
			++numBytes;
		} else if (ch &lt; 0xD800 || ch > 0xDFFF) {
			numBytes += 2;
		} else {
			// surrogate pair
			// confirm valid high surrogate
			if (ch &lt; 0xDC00 &amp;&amp; (i &lt; end - 1)) {
				var ch2 = s.charCodeAt(i + 1);
				// confirm valid low surrogate
				if (ch2 >= 0xDC00 &amp;&amp; ch2 &lt;= 0xDFFF) {
					numBytes += 2;
					++i;
					continue;
				}
			}
			// invalid surrogate pair; will use 3 byte replacement when writing utf-8 bytes
			numBytes += 2;
		}
	}
	return numBytes;
}

/**
 * @param {!Serializer} ser
 * @param {string} str
 */
function writeUtf8(ser, str) {
	var end = str.length;
	var bpos = ser.i;
	var buff = ser.b;
	for (var i = 0; i &lt; end; ++i) {
		if (bpos + 4 > buff.length) {
			ser.i = bpos;
			flushBuff(ser);
			bpos = ser.i;
			buff = ser.b;
		}
		var ch = str.charCodeAt(i);
		if (ch &lt; 0x80) {
			buff[bpos++] = ch;
		} else if (ch &lt; 0x800) {
			buff[bpos++] = 0xC0 | (ch >> 6);
			buff[bpos++] = 0x80 | (ch &amp; 0x3F);
		} else if (ch &lt; 0xD800 || ch > 0xDFFF) {
			buff[bpos++] = 0xE0 | (ch >> 12);
			buff[bpos++] = 0x80 | ((ch >> 6) &amp; 0x3F);
			buff[bpos++] = 0x80 | (ch &amp; 0x3F);
		} else {
			// surrogate pair
			// confirm valid high surrogate
			if (ch &lt; 0xDC00 &amp;&amp; (i &lt; end - 1)) {
				var ch2 = str.charCodeAt(i + 1);
				// confirm valid low surrogate and write pair
				if (ch2 >= 0xDC00 &amp;&amp; ch2 &lt;= 0xDFFF) {
					ch2 = (ch &lt;&lt; 10) + ch2 + SURROGATE_OFFSET;
					++i;
					buff[bpos++] = 0xF0 | (ch2 >> 18);
					buff[bpos++] = 0x80 | ((ch2 >> 12) &amp; 0x3F);
					buff[bpos++] = 0x80 | ((ch2 >> 6) &amp; 0x3F);
					buff[bpos++] = 0x80 | (ch2 &amp; 0x3F);
					continue;
				}
			}
			// replace unpaired surrogate or out-of-order low surrogate with substitution character
			buff[bpos++] = 0xEF;
			buff[bpos++] = 0xBF;
			buff[bpos++] = 0xBD;
		}
	}
	ser.i = bpos;
}

/**
 * @param {!Serializer} s
 * @param {number} l
 */
function ensureSpace(s, l) {
	if (s.i + l > s.b.length) {
		flushBuff(s);
	}
}

/**
 * @param {!Serializer} s
 * @param {number} t
 * @param {number} v
 */
function writeTypeAndVarint(s, t, v) {
	ensureSpace(s, 10);
	if (t != 0) {
		s.b[s.i++] = t;
	}
	while (v > 0x7FFFFFFF) {
		// numbers greater than 31 bits need to use math ops. cannot use bit ops
		s.b[s.i++] = 0x80 | (v % 128);
		v = Math.floor(v / 128);
	}
	while (v > 0x7F) {
		s.b[s.i++] = 0x80 | (v &amp; 0xFF);
		v >>>= 7;
	}
	s.b[s.i++] = v;
}

/**
 * @param {!Serializer} s
 * @param {number} t
 * @param {!BigInteger} v
 */
function writeTypeAndBigBytes(s, t, v) {
	if (v.signum() &lt; 0) {
		writeTypeAndBigBytes(s, t, bigIntNegateTo(v, TMPBI2));
		return;
	}
	var bitLen = v.bitLength();
	var numBytes = (bitLen >> 3) + ((bitLen &amp; 0x7) == 0 ? 0 : 1);
	// TODO: implement a function that doesn't require memory allocation
	var buff = v.toByteArray();
	if (!(buff.length == numBytes || buff.length == numBytes + 1)) {
		throw new Error("BigInteger.toByteArray() returned unexpected value");
	}
	writeTypeAndVarint(s, t, numBytes);
	for (var i = buff.length - numBytes; i &lt; buff.length; ++i) {
		s.write1(buff[i]);
	}
}

/**
 * @param {!Serializer} s
 * @param {number} t
 * @param {!BigInteger} v
 */
function writeBIAsVI(s, t, v) {
	if (v.signum() &lt; 0) {
		writeBIAsVI(s, t, bigIntNegateTo(v, TMPBI2));
		return;
	}

	ensureSpace(s, 10);
	if (t != 0) {
		s.b[s.i++] = t;
	}

	if (v.compareTo(BIGINT31) > 0) {
		if (v != TMPBI2) {
			v.copyTo(TMPBI2);
			v = TMPBI2;
		}
		while (v.compareTo(BIGINT31) > 0) {
			s.b[s.i++] = 0x80 | (v.byteValue() &amp; 0x7F);
			v.rShiftTo(7, v);
		}
	}

	var intv = v.intValue();
	while (intv > 0x7F) {
		s.b[s.i++] = 0x80 | (intv &amp; 0xFF);
		intv >>>= 7;
	}
	s.b[s.i++] = intv;
}

/**
 * @param {!Serializer} s
 * @param {!BigInteger} v
 */
function writeBigInt(s, v) {
	var sn = v.signum();
	if (sn == 0) {
		s.write1(CH_ZERO);
	} else if (sn > 0) {
		if (v.compareTo(BIMAXVARINT) &lt;= 0) {
			writeBIAsVI(s, CH_POSVARINT, v);
		} else {
			writeTypeAndBigBytes(s, CH_POSBIGINT, v);
		}
	} else {
		if (v.compareTo(BIMINVARINT) >= 0) {
			writeBIAsVI(s, CH_NEGVARINT, v);
		} else {
			writeTypeAndBigBytes(s, CH_NEGBIGINT, v);
		}
	}
}

/**
 * @param {!Serializer} s
 * @param {!BigDec} v
 */
function writeBigDec(s, v) {
	var e = 0 - v.scale();
	var m = v.unscaledValue();
	if (e == 0) {
		writeBigInt(s, m);
	} else {
		var negExp = e &lt; 0;
		e = negExp ? 0 - e : e;
		if (v.signum() > 0) {
			if (m.compareTo(BIMAXVARINT) &lt;= 0) {
				writeTypeAndVarint(s, negExp ? CH_NEGPOSVARDEC : CH_POSPOSVARDEC, e);
				writeBIAsVI(s, 0, m);
			} else {
				writeTypeAndVarint(s, negExp ? CH_NEGPOSBIGDEC : CH_POSPOSBIGDEC, e);
				writeTypeAndBigBytes(s, 0, m);
			}
		} else {
			if (m.compareTo(BIMINVARINT) >= 0) {
				writeTypeAndVarint(s, negExp ? CH_NEGNEGVARDEC : CH_POSNEGVARDEC, e);
				writeBIAsVI(s, 0, m);
			} else {
				writeTypeAndVarint(s, negExp ? CH_NEGNEGBIGDEC : CH_POSNEGBIGDEC, e);
				writeTypeAndBigBytes(s, 0, m);
			}
		}
	}
}

/**
 * Write a single byte
 * @param {number} v
 * @memberof Serializer
 */
Serializer.prototype.write1 = function(v) {
	if (this.i >= this.b.length) {
		flushBuff(this);
	}
	this.b[this.i++] = v;
};

/**
 * Write a raw byte array
 * @param {!Uint8Array} b
 * @memberof Serializer
 */
Serializer.prototype.write = function(b) {
	if (b.length > this.b.length - this.i) {
		flushBuff(this);
		if (b.length >= this.b.length) {
			this.c = this.o.write(b);
			return;
		}
	}
	this.b.set(b, this.i);
	this.i += b.length;
};

/**
 * Force any buffered bytes to be written
 * @memberof Serializer
 */
Serializer.prototype.flush = function() {
	flushBuff(this);
	if (typeof this.o.flush === "function") {
		this.o.flush();
	}
};

/**
 * Serialize a number
 * @param {number} v
 * @memberof Serializer
 */
Serializer.prototype.writeNumber = function(v) {
	if (isSafeInteger(v)) {
		if (v > 0) {
			writeTypeAndVarint(this, CH_POSVARINT, v);
		} else if (v == 0 &amp;&amp; (1 / v == Infinity)) {
			this.write1(CH_ZERO);
		} else {
			writeTypeAndVarint(this, CH_NEGVARINT, 0 - v);
		}
	} else if (v === -Infinity) {
		this.write1(CH_NEGINF);
	} else if (v === Infinity) {
		this.write1(CH_POSINF);
	} else {
		if (typeof v != "number") {
			throw new Error("not a number");
		}
		if (isNaN(v)) {
			throw new Error("number is NaN; cannot be serialized");
		}
		writeBigDec(this, new BigDec(v.toString()));
	}
};

/**
 * Serialize a string
 * @param {string} v
 * @memberof Serializer
 */
Serializer.prototype.writeString = function(v) {
	if (v.length == 0) {
		this.write1(CH_EMPTYSTR);
		return;
	}
	if (v.length &lt; 1024) {
		// TODO: what is the proper cutoff string length to use the built-in encoder vs iterating over each char?
		writeTypeAndVarint(this, CH_STRLPVI, getUtf8Len(v, 0, v.length));
		writeUtf8(this, v);
	} else {
		var b = STRENC(v);
		writeTypeAndVarint(this, CH_STRLPVI, b.length);
		this.write(b);
	}
};

/**
 * Serialize an Array
 * @param {!Array} v
 * @memberof Serializer
 */
Serializer.prototype.writeArray = function(v) {
	if (v.length == 0) {
		this.write1(CH_EMPTYARRAY);
	} else {
		this.write1(CH_ARRAYSTART);
		for (var i = 0; i &lt; v.length; ++i) {
			this.writeObject(v[i]);
		}
		this.write1(CH_ARRAYEND);
	}
};

/**
 * Serialize any supported value (undefined/null/boolean/number/bigint/string/Uint8Array/BigInteger/BigDec/OpaDef.SORTMAX_OBJ)
 * or an Object with toOpaSO() property, or an Array containing any of the previously listed types.
 * @param {*} v
 * @memberof Serializer
 */
Serializer.prototype.writeObject = function(v) {
	// TODO: handle iterable objects?
	//  https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Iteration_protocols
	switch (typeof v) {
		case "string":
			this.writeString(v);
			break;
		case "number":
			this.writeNumber(v);
			break;
		case "bigint":
			// note: this is here to attempt initial support for native bigint. It has not been tested.
			// TODO: test this! Chrome v67 and later should support bigints. Eventually more browsers will add support
			// TODO: this will be slow. add code to avoid conversion
			writeBigInt(this, bigIntFromNativeBigInt(/** @type {bigint} */(v)));
			break;
		case "boolean":
			this.write1(v ? CH_TRUE : CH_FALSE);
			break;
		case "undefined":
			this.write1(CH_UNDEFINED);
			break;
		case "object":
			v = /** @type {?Object} */ (v); // eslint-disable-line no-self-assign
			if (v === null) {
				this.write1(CH_NULL);
			} else if (Object.prototype.hasOwnProperty.call(v, "toOpaSO") &amp;&amp; typeof v.toOpaSO == "function") {
				v.toOpaSO(this);
			} else if (Array.isArray(v)) {
				this.writeArray(v);
			} else if (v === OpaDef.SORTMAX_OBJ) {
				this.write1(CH_SORTMAX);
			} else if (v instanceof BigInteger) {
				writeBigInt(this, v);
			} else if (v instanceof BigDec) {
				writeBigDec(this, v);
			} else if (v.constructor.name == "Uint8Array" || v.constructor.name == "Buffer") {
				v = /** @type {!Uint8Array} */ (v); // eslint-disable-line no-self-assign
				if (v.length == 0) {
					this.write1(CH_EMPTYBIN);
				} else {
					writeTypeAndVarint(this, CH_BINLPVI, v.length);
					this.write(v);
				}
			} else {
				throw new Error("unsupported object type " + v.constructor.name);
			}
			break;
		default:
			throw new Error("unsupported type " + typeof v);
	}
};

}());

</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.10</a> using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>

<script src="scripts/search.js" defer></script>


<script src="scripts/collapse.js" defer></script>


</body>
</html>
